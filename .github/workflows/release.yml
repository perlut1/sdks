name: Release new version

on:
  workflow_dispatch:
    inputs:
      sdk:
        type: choice
        description: SDK to release
        required: true
        options:
          - aqua
          - cross-chain
          - fusion
          - limit-order
      version:
        type: choice
        description: Version bump type
        required: true
        options:
          - patch
          - minor
          - major
          - prerelease

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install Dev Dependencies
        run: pnpm install -D

      - name: Get SDK info
        id: sdk_info
        run: |
          SDK_PATH="typescript/${{ github.event.inputs.sdk }}"
          echo "SDK_PATH=$SDK_PATH" >> "$GITHUB_OUTPUT"
          cd $SDK_PATH
          echo "OLD_VERSION=$(pnpm pkg get version | tr -d '"')" >> "$GITHUB_OUTPUT"

      - name: Bump package.json version
        id: version
        run: |
          cd ${{ steps.sdk_info.outputs.SDK_PATH }}
          pnpm version ${{ github.event.inputs.version }} --preid rc --git-tag-version=false
          echo "NEW_VERSION=$(pnpm pkg get version | tr -d '"')" >> "$GITHUB_OUTPUT"

      - name: Generate changelog
        run: |
          cd ${{ steps.sdk_info.outputs.SDK_PATH }}
          # Try to generate changelog from the last tag for this SDK
          LAST_TAG="${{ github.event.inputs.sdk }}-v${{ steps.sdk_info.outputs.OLD_VERSION }}"
          pnpm changelog:generate -t $LAST_TAG || pnpm changelog:generate

      - name: Create github release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.email ci_cd_bot@1inch.io
          git config --global user.name "CI/CD Bot"
          
          cd ${{ steps.sdk_info.outputs.SDK_PATH }}
          git add package.json
          git commit -m "version @1inch/${{ github.event.inputs.sdk }}-sdk v${{ steps.version.outputs.NEW_VERSION }}"
          
          TAG_NAME="${{ github.event.inputs.sdk }}-v${{ steps.version.outputs.NEW_VERSION }}"
          git tag $TAG_NAME
          git push
          git push --tags
          
          if [ -f CHANGELOG.md ]; then
            gh release create $TAG_NAME --notes-file CHANGELOG.md --title "@1inch/${{ github.event.inputs.sdk }}-sdk v${{ steps.version.outputs.NEW_VERSION }}"
          else
            gh release create $TAG_NAME --generate-notes --title "@1inch/${{ github.event.inputs.sdk }}-sdk v${{ steps.version.outputs.NEW_VERSION }}"
          fi

      - name: Trigger publish
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh workflow run publish.yml -r ${{ github.event.inputs.sdk }}-v${{ steps.version.outputs.NEW_VERSION }}